<% content_for :page_title do %>
  Calendrier
<% end %>

<% content_for :navbar_actions do %>
  <div class="flex items-center space-x-4">
    <%= link_to calendars_path(date: Date.current.strftime('%Y-%m-%d')),
                class: "inline-flex items-center px-4 py-2 bg-green-700 text-white rounded-lg shadow hover:bg-green-600 transition font-medium",
                data: { turbo: false },
                title: "Aller à aujourd'hui" do %>
      <i class="fas fa-calendar-day mr-2"></i>
      Aujourd'hui
    <% end %>

    <div class="flex items-center space-x-2">
      <%= link_to calendars_path(date: (@selected_date - 1.day).strftime('%Y-%m-%d')),
                  class: "p-2 text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition",
                  data: { turbo: false } do %>
        <i class="fas fa-chevron-left"></i>
      <% end %>

      <input type="date"
             id="date-selector"
             value="<%= @selected_date.strftime('%Y-%m-%d') %>"
             class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
             data-controller="date-selector">

      <%= link_to calendars_path(date: (@selected_date + 1.day).strftime('%Y-%m-%d')),
                  class: "p-2 text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition",
                  data: { turbo: false } do %>
        <i class="fas fa-chevron-right"></i>
      <% end %>
    </div>
  </div>
<% end %>

<div class="max-w-6xl mx-auto mt-16 bg-white rounded-xl shadow-md p-8" id="calendar-content">
  <div class="mb-8">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-3xl font-bold text-blue-800">
        <%= l(@selected_date, format: :long) %>
      </h1>

      <%= link_to new_day_day_food_path(@day), class: "inline-flex items-center px-4 py-2 bg-blue-800 text-white rounded-lg shadow hover:bg-blue-600 transition font-medium" do %>
        <i class="fas fa-plus mr-2"></i>
        Ajouter un aliment
      <% end %>
    </div>

    <!-- Résumé des totaux -->
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 bg-gray-50 rounded-lg p-4">
      <div class="text-center">
        <div class="text-2xl font-bold text-blue-600"><%= @total_calories %> kcal</div>
        <div class="text-sm text-gray-600"><%= Food.human_attribute_name(:calories) %></div>
      </div>
      <div class="text-center">
        <div class="text-2xl font-bold text-green-600"><%= @total_proteins %> g</div>
        <div class="text-sm text-gray-600"><%= Food.human_attribute_name(:proteins) %></div>
      </div>
      <div class="text-center">
        <div class="text-2xl font-bold text-yellow-600"><%= @total_carbs %> g</div>
        <div class="text-sm text-gray-600"><%= Food.human_attribute_name(:carbs) %></div>
      </div>
      <div class="text-center">
        <div class="text-2xl font-bold text-red-600"><%= @total_fats %> g</div>
        <div class="text-sm text-gray-600"><%= Food.human_attribute_name(:fats) %></div>
      </div>
      <div class="text-center">
        <div class="text-2xl font-bold text-purple-600"><%= @total_sugars %> g</div>
        <div class="text-sm text-gray-600"><%= Food.human_attribute_name(:sugars) %></div>
      </div>
    </div>
  </div>

  <div class="space-y-6">
    <% if @day_foods.any? %>
      <!-- Afficher les groupes de repas -->
      <% @day_foods_by_group.each do |day_food_group, day_foods| %>
        <%= render DayFoodGroupComponent.new(day_food_group: day_food_group, day_foods: day_foods) %>
      <% end %>

            <!-- Afficher les aliments sans groupe -->
      <% if @day_foods_without_group.any? %>
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden" data-controller="collapsible">
          <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-3">
                <button class="text-gray-600 hover:text-blue-600 transition-colors"
                        data-action="click->collapsible#toggle"
                        data-collapsible-target="trigger">
                  <i class="fas fa-chevron-down transition-transform duration-200" data-collapsible-target="icon"></i>
                </button>
                <h3 class="text-lg font-semibold text-gray-800">
                  Aliments sans groupe
                </h3>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                  <%= @day_foods_without_group.count %> aliment<%= 's' if @day_foods_without_group.count > 1 %>
                </span>
              </div>

              <!-- Totaux des aliments sans groupe -->
              <div class="flex items-center space-x-4 text-sm">
                <div class="text-center">
                  <div class="font-semibold text-blue-600"><%= @day_foods_without_group.sum(&:total_calories).round(1) %> kcal</div>
                  <div class="text-gray-500">Calories</div>
                </div>
                <div class="text-center">
                  <div class="font-semibold text-green-600"><%= @day_foods_without_group.sum(&:total_proteins).round(1) %> g</div>
                  <div class="text-gray-500">Protéines</div>
                </div>
                <div class="text-center">
                  <div class="font-semibold text-yellow-600"><%= @day_foods_without_group.sum(&:total_carbs).round(1) %> g</div>
                  <div class="text-gray-500">Glucides</div>
                </div>
                <div class="text-center">
                  <div class="font-semibold text-red-600"><%= @day_foods_without_group.sum(&:total_fats).round(1) %> g</div>
                  <div class="text-gray-500">Lipides</div>
                </div>
                <div class="text-center">
                  <div class="font-semibold text-purple-600"><%= @day_foods_without_group.sum(&:total_sugars).round(1) %> g</div>
                  <div class="text-gray-500">Sucres</div>
                </div>
              </div>
            </div>
          </div>

          <div class="hidden" data-collapsible-target="content">
            <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase"><%= Food.human_attribute_name(:name) %></th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase"><%= Food.human_attribute_name(:brand) %></th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Quantité</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase"><%= Food.human_attribute_name(:calories) %></th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase"><%= Food.human_attribute_name(:proteins) %></th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase"><%= Food.human_attribute_name(:carbs) %></th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase"><%= Food.human_attribute_name(:fats) %></th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase"><%= Food.human_attribute_name(:sugars) %></th>
                  <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <% @day_foods_without_group.each do |day_food| %>
                  <tr>
                    <td class="px-4 py-2 font-medium"><%= day_food.food.name %></td>
                    <td class="px-4 py-2 text-gray-600"><%= day_food.food.brand %></td>
                    <td class="px-4 py-2"><%= day_food.quantity %> g</td>
                    <td class="px-4 py-2 font-semibold text-blue-600"><%= day_food.total_calories %> kcal</td>
                    <td class="px-4 py-2 text-green-600"><%= day_food.total_proteins %> g</td>
                    <td class="px-4 py-2 text-yellow-600"><%= day_food.total_carbs %> g</td>
                    <td class="px-4 py-2 text-red-600"><%= day_food.total_fats %> g</td>
                    <td class="px-4 py-2 text-purple-600"><%= day_food.total_sugars %> g</td>
                    <td class="px-4 py-2 text-center">
                      <%= link_to edit_day_day_food_path(@day, day_food), class: "inline-block text-blue-600 hover:text-blue-900 mr-2", title: "Modifier" do %>
                        <i class="fa fa-pencil"></i>
                      <% end %>
                      <%= delete_link_with_confirm(day_day_food_path(@day, day_food),
                                                  confirm: "Es-tu sûr de vouloir supprimer cet aliment ?",
                                                  title: "Supprimer") %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  <% end %>
    <% else %>
      <div class="text-center py-12">
        <i class="fas fa-utensils text-6xl text-gray-300 mb-4"></i>
        <h3 class="text-lg font-medium text-gray-900 mb-2">Aucun aliment consommé</h3>
        <p class="text-gray-600 mb-6">Vous n'avez pas encore ajouté d'aliments pour cette journée.</p>
        <%= link_to new_day_day_food_path(@day), class: "inline-flex items-center px-6 py-3 bg-blue-800 text-white rounded-lg shadow hover:bg-blue-600 transition font-medium" do %>
          <i class="fas fa-plus mr-2"></i>
          Ajouter votre premier aliment
        <% end %>
      </div>
    <% end %>
  </div>
</div>
